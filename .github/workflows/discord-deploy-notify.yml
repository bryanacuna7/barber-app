name: Discord Deploy Notification

on:
  push:
    branches: ['**']
    paths:
      - 'RELEASE_NOTES.md'

jobs:
  notify:
    name: Notify Discord
    runs-on: ubuntu-latest
    timeout-minutes: 2

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Send Discord notification
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK_URL }}
        run: |
          # Extract version from RELEASE_NOTES.md
          VERSION=$(grep -m1 '^## ' RELEASE_NOTES.md | sed 's/^## //')

          # Extract body: everything after the first ## line until EOF
          BODY=$(awk '/^## /{if(found) exit; found=1; next} found' RELEASE_NOTES.md)

          # Format: remove HTML comments, convert ### to bold
          FORMATTED=$(echo "$BODY" \
            | sed '/^<!--/,/-->/d' \
            | sed 's/^### \(.*\)/**\1**/' \
            | sed '/^$/N;/^\n$/d')

          TIMESTAMP=$(date -u +%Y-%m-%dT%H:%M:%S.000Z)

          # Build JSON payload using python3 for safe escaping
          python3 -c "
          import json, sys

          description = sys.stdin.read().strip()
          version = '$VERSION'
          timestamp = '$TIMESTAMP'

          payload = {
              'embeds': [{
                  'title': f'\U0001f4f2 BarberApp â€” {version}',
                  'description': description,
                  'color': 5025616,
                  'footer': {'text': 'BarberApp Updates'},
                  'timestamp': timestamp
              }]
          }

          print(json.dumps(payload, ensure_ascii=False))
          " <<< "$FORMATTED" > /tmp/payload.json

          # Send to Discord
          RESPONSE=$(curl -s -w "\n%{http_code}" -H "Content-Type: application/json" \
            -d @/tmp/payload.json \
            "$DISCORD_WEBHOOK")

          HTTP_CODE=$(echo "$RESPONSE" | tail -1)
          BODY_RESP=$(echo "$RESPONSE" | head -n -1)

          echo "HTTP Status: $HTTP_CODE"
          echo "Response: $BODY_RESP"

          if [ "$HTTP_CODE" -lt 200 ] || [ "$HTTP_CODE" -ge 300 ]; then
            echo "::error::Discord notification failed with status $HTTP_CODE"
            exit 1
          fi

          echo "Discord notification sent successfully"
